<html>
<head>
	<link rel="stylesheet" href="/css/messaggi.css">
	<link rel="stylesheet" href="/css/menu.css">
	<script type="text/javascript">if (document.cookie.indexOf('email=') == -1) self.location='login.html';</script>
	
</head>

<body>
	<div class="header-mobile-extended-container" id="header-mobile-extended-container">
    <div class="header-mobile-extended-container1">
      <img src="icon/close_big.png" alt="image" class="header-mobile-extended-image" onclick="close_navbar()"/>
      <div class="header-mobile-extended-container2">
        <img src="/icon/File_dock.png" alt="image" class="menu-noteicon"/>
        <a href="note.html"   style="margin-bottom: 10px;">Note</a>
      </div>
      <div class="header-mobile-extended-container3">
        <img src="/icon/Folder_line.png" alt="image" class="menu-libreriaicon"/>
        <a href="Library.html"   style="margin-bottom: 10px;">Libreria</a>
      </div>
      <div class="header-mobile-extended-container4">
        <img src="/icon/coolicon.png" alt="image" class="menu-cestinoicon" />
         <a href="Trash.html"   style="margin-bottom: 10px;">Cestino </a>
      </div>
      <div class="header-mobile-extended-container5">
        <img src="/icon/User.png" alt="image" class="menu-profiloicon"/>
        <a href="profilo.html"   style="margin-bottom: 10px;">Profilo</a>
      </div>
      <div class="header-mobile-extended-container6">
        <img src="/icon/Sign_out_squre_fill.png" alt="image" class="menu-esciicon"/>
        <a href="esci"   class="esci">Esci</a>
      </div>
    </div>
  </div>
  
<div class="header-mobile-container">
    <div class="header-mobile-container1">
      <div class="header-mobile-hamburgercontainer">
        <img src="/icon/menu_alt_03.png" alt="image" class="header-mobile-hamburgericon" id="hamburger" onclick="open_navbar()"/>
      </div>
      <img src="/icon/Logo_icon.png" alt="image" class="header-mobile-logomobile" onclick="location.href='index.html'"/>
      <div class="header-mobile-rightcontainer">
        <input type="text" placeholder="Cerca ..." class="header-mobile-cercainput input" name="cerca_input_mobile" onchange="location.href='Search.html'"/>
        <img src="/icon/Search_black_alt.png" alt="image" class="header-mobile-cercaiconmobile" onclick="location.href='Search.html'"/>
        <img src="/icon/Send_fill.png" alt="image" class="header-mobile-messaggiiconmobile" onclick="location.href='lista_messaggi.html'"/>
      </div>
    </div>
  </div>
  
 <div class="header-container">
    <div class="header-container1">
      <div class="header-cercacontainer">
        <img src="/icon/Search_black_alt.png" alt="image" class="header-cercaicon" />
        <input type="text" placeholder="Cerca ..." class="header-cercainput" name="cerca_input" onchange="location.href='Search.html'"/>
      </div>
      <img src="/icon/Send_fill.png" alt="image" class="header-messaggiicon" onclick="location.href='lista_messaggi.html'"/>
    </div>
  </div>
  
	<div class="menu-container">
    <div class="menu-container1">
      <div class="menu-logocontainer">
        <img src="/icon/Logo_icon_white.png" alt="image" class="menu-logo" onclick="location.href='index.html'"/>
      </div>
      <div class="menu-middlecontainer">
        <div class="menu-containerprincipallink">
          <div class="menu-containernote">
            <img src="/icon/File_dock.png" alt="image" class="menu-noteicon"/>
            <a href="note.html"  >Note</a>
          </div>
          <div class="menu-containerlibreria">
            <img src="/icon/Folder_line.png" alt="image" class="menu-libreriaicon"/>
            <a href="Library.html"  >Libreria</a>
          </div>
          <div class="menu-containercestino">
            <img src="/icon/coolicon.png" alt="image" class="menu-cestinoicon" />
            <a href="Trash.html"  >Cestino </a>
          </div>
        </div>
      </div>
      <div class="menu-bottomcontainer">
        <div class="menu-containerlink">
          <div class="menu-containerprofilo">
            <img src="/icon/User.png" alt="image" class="menu-profiloicon"/>
            <a href="profilo.html"  >Profilo</a>
          </div>
          <div class="menu-containeresci">
            <img src="/icon/Sign_out_squre_fill.png" alt="image" class="menu-esciicon"/>
            <a href="esci"   class="esci">Esci</a>
          </div>
        </div>
      </div>
    </div>
  </div>
<script src="Javascripts/main.js"></script>

	<div class="home-container">
    <div class="home-container1">
      <div class="home-header">
        <img
          src="icon/Expand_left.png"
          alt="image"
          class="home-backicon"
          onclick="self.location='lista_messaggi.html'"
        />
        <img
          src="icon/ImmagineProfiloPersonale.jpeg"
          alt="image"
          class="home-usericon"
        />
        <span class="home-nomeutente" id="nome_Utente"></span>

      </div>
      <div class="home-messaggiobox" id="boxMessaggi">
        
      </div>
      <div class="home-inviomessaggiobox">
        <input
          type="text"
          placeholder="Digita il tuo testo qui ..."
          class="home-inputtesto input"
          id="testo"
        />
        <img
          src="icon/Send_hor_fill.png"
          alt="image"
          class="home-image"
          onclick="sendMessage(document.getElementById('testo').value)"
          
        />
      </div>
    </div>
  </div>
  
  <script type="text/javascript">
	const spanArray = new Array();
	
	const emailToContact = document.cookie
	  .split('; ')
	  .find(row => row.startsWith('emailToContact'))
	  .split('=')[1];	
	
	const email = document.cookie
	  .split('; ')
	  .find(row => row.startsWith('email'))
	  .split('=')[1];
	
	var xhttp1 = new XMLHttpRequest();
	xhttp1.open("GET","/getConversazione?email="+email + "&emailToContact=" + emailToContact, true);
	xhttp1.send();
		xhttp1.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			var file=this.response;
			if(file != null){
				var conversazione = atob(file);
				console.log(conversazione);
				var id = 0;
				while(conversazione.indexOf("MITTENTE#") != -1 || conversazione.indexOf("DESTINATARIO#") != -1){
					if(conversazione.indexOf("MITTENTE#") != -1){
						var messaggioMittente = conversazione.substring(conversazione.indexOf("MITTENTE#")+9, conversazione.indexOf("FINEMITTENTE#"));
						conversazione = conversazione.substring(conversazione.indexOf("FINEMITTENTE#")+13, conversazione.length)
						var container= document.createElement("div");
						container.classList.add("home-messaggiobox2");
						var span = document.createElement("span");
						span.classList.add("home-testomessaggio");
						span.setAttribute("id", "mittente");
						span.innerHTML = messaggioMittente;
						container.appendChild(span);
						document.getElementById("boxMessaggi").appendChild(container);
						spanArray.push(span);
					}
					if(conversazione.indexOf("DESTINATARIO#") != -1){
						var messaggioDestinatario = conversazione.substring(conversazione.indexOf("DESTINATARIO#")+13, conversazione.indexOf("FINEDESTINATARIO#"));
						conversazione = conversazione.substring(conversazione.indexOf("FINEDESTINATARIO#")+17, conversazione.length)
						var container= document.createElement("div");
						container.classList.add("home-messaggiobox1");
						var span = document.createElement("span");
						span.classList.add("home-testomessaggio1");
						span.setAttribute("id", "destinatario");
						span.innerHTML = messaggioDestinatario;
						container.appendChild(span);
						document.getElementById("boxMessaggi").appendChild(container);
						spanArray.push(span);
					}
				}
			}
		}
	};
	
	
	function sendMessage(testo){console.log(spanArray.length);
		var container= document.createElement("div");
		container.classList.add("home-messaggiobox2");
		var span = document.createElement("span");
		span.classList.add("home-testomessaggio");
		span.setAttribute("id", "mittente");
		span.innerHTML = testo;
		container.appendChild(span);
		document.getElementById("boxMessaggi").appendChild(container);
		spanArray.push(span);
		document.getElementById('testo').value = "";
		
		var mittente = "";
		var destinatario = "";
		for(var i=0; i<spanArray.length; i++){
			if(spanArray[i].getAttribute("id") == "mittente"){
				mittente = mittente + "MITTENTE#" + spanArray[i].innerText + "FINEMITTENTE#";
				destinatario = destinatario + "DESTINATARIO#" + spanArray[i].innerText + "FINEDESTINATARIO#";
			}
			
			if(spanArray[i].getAttribute("id") == "destinatario"){
				mittente = mittente + "DESTINATARIO#" + spanArray[i].innerText + "FINEDESTINATARIO#";
				destinatario = destinatario + "MITTENTE#" + spanArray[i].innerText + "FINEMITTENTE#";
			}
		}
		
		var xhttp = new XMLHttpRequest();
		xhttp.open("POST","/setConversazione?email="+email + "&emailToContact=" + emailToContact + "&mittente=" + btoa(mittente) + "&destinatario=" + btoa(destinatario), true);
		xhttp.send();
	}
	</script>
  
  <script>
  
  
  var xhttp = new XMLHttpRequest();
	
	xhttp.open("GET","/getUtente?email="+emailToContact, true);
	xhttp.send();
		xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			var utente=JSON.parse([this.response]);
  			document.getElementById("nome_Utente").innerHTML = utente.nome;
		}
	};
  </script>
</body>
</html>