<html>
<head>
	<title>Rift</title>
  	<meta charset="UTF-8">
  	<link rel="stylesheet" href="/css/menu.css">
	<link rel="stylesheet" href="fontawesome/css/all.css">
	<link rel="stylesheet" href="/css/nota_css.css">
	<script type="text/javascript">if (document.cookie.indexOf('email=') == -1) self.location='FirstPage.html';</script>
</head>

<body onload="font()">
<div class="home-conferma" id="conferma">
      <label class="home-domanda">
        Vuoi pubblicare la nota sul portale Rif, rendendola visibile anche agli
        altri utenti?
      </label>
      <div class="home-risposte">
        <label class="home-pubblica" onclick="hideConferma(true)">Pubblica</label>
        <label class="home-nonpubblicare" onclick="hideConferma(false)">Non pubblicare</label>
      </div>
      	<label class="annulla" onclick="exitConferma()">Annulla operazione</label>
    </div>

<div class="header-mobile-extended-container" id="header-mobile-extended-container">
    <div class="header-mobile-extended-container1">
      <img src="icon/close_big.png" alt="image" class="header-mobile-extended-image" onclick="close_navbar()"/>
      <div class="header-mobile-extended-container2">
        <img src="/icon/File_dock.png" alt="image" class="menu-noteicon"/>
        <a href="note.html"   style="margin-bottom: 10px;">Note</a>
      </div>
      <div class="header-mobile-extended-container3">
        <img src="/icon/Folder_line.png" alt="image" class="menu-libreriaicon"/>
        <a href="Library.html"   style="margin-bottom: 10px;">Libreria</a>
      </div>
      <div class="header-mobile-extended-container4">
        <img src="/icon/coolicon.png" alt="image" class="menu-cestinoicon" />
         <a href="Trash.html"   style="margin-bottom: 10px;">Cestino </a>
      </div>
      <div class="header-mobile-extended-container5">
        <img src="/icon/User.png" alt="image" class="menu-profiloicon"/>
        <a href="profilo.html"   style="margin-bottom: 10px;">Profilo</a>
      </div>
      <div class="header-mobile-extended-container6">
        <img src="/icon/Sign_out_squre_fill.png" alt="image" class="menu-esciicon"/>
        <a href="esci"   class="esci">Esci</a>
      </div>
    </div>
  </div>
  
<div class="header-mobile-container">
    <div class="header-mobile-container1">
      <div class="header-mobile-hamburgercontainer">
        <img src="/icon/menu_alt_03.png" alt="image" class="header-mobile-hamburgericon" id="hamburger" onclick="open_navbar()"/>
      </div>
      <img src="/icon/Logo_icon.png" alt="image" class="header-mobile-logomobile" onclick="location.href='index.html'"/>
      <div class="header-mobile-rightcontainer">
        <input type="text" placeholder="Cerca ..." class="header-mobile-cercainput input" name="cerca_input_mobile" onchange="location.href='Search.html'"/>
        <img src="/icon/Search_black_alt.png" alt="image" class="header-mobile-cercaiconmobile" onclick="location.href='Search.html'"/>
        <img src="/icon/Send_fill.png" alt="image" class="header-mobile-messaggiiconmobile" onclick="location.href='lista_messaggi.html'"/>
      </div>
    </div>
  </div>
  
 <div class="header-container">
    <div class="header-container1">
      <div class="header-cercacontainer">
        <img src="/icon/Search_black_alt.png" alt="image" class="header-cercaicon" />
        <input type="text" placeholder="Cerca ..." class="header-cercainput" name="cerca_input" onchange="location.href='Search.html'"/>
      </div>
      <img src="/icon/Send_fill.png" alt="image" class="header-messaggiicon" onclick="location.href='lista_messaggi.html'"/>
    </div>
  </div>
  
	<div class="menu-container">
    <div class="menu-container1">
      <div class="menu-logocontainer">
        <img src="/icon/Logo_icon_white.png" alt="image" class="menu-logo" onclick="location.href='index.html'"/>
      </div>
      <div class="menu-middlecontainer">
        <div class="menu-containerprincipallink">
          <div class="menu-containernote">
            <img src="/icon/File_dock.png" alt="image" class="menu-noteicon"/>
            <a href="note.html"  >Note</a>
          </div>
          <div class="menu-containerlibreria">
            <img src="/icon/Folder_line.png" alt="image" class="menu-libreriaicon"/>
            <a href="Library.html"  >Libreria</a>
          </div>
          <div class="menu-containercestino">
            <img src="/icon/coolicon.png" alt="image" class="menu-cestinoicon" />
            <a href="Trash.html"  >Cestino </a>
          </div>
        </div>
      </div>
      <div class="menu-bottomcontainer">
        <div class="menu-containerlink">
          <div class="menu-containerprofilo">
            <img src="/icon/User.png" alt="image" class="menu-profiloicon"/>
            <a href="profilo.html"  >Profilo</a>
          </div>
          <div class="menu-containeresci">
            <img src="/icon/Sign_out_squre_fill.png" alt="image" class="menu-esciicon"/>
            <a href="esci"   class="esci">Esci</a>
          </div>
        </div>
      </div>
    </div>
  </div>
<script src="Javascripts/main.js"></script>

<div class="content">
<div class="home-container1">
      <input type="text" placeholder="Inserisci il titolo della nota..." id="titolo_nota">
      <img
        alt="image"
        src="icon/Check_ring_round.png"
        class="home-save"
        onclick="showConferma()"
      />
      <img
        alt="image"
        src="icon/more_horizontal.png"
        class="home-moreoption"
      />
    </div>
	
	<iframe id="output" name="textfield" src=""></iframe><br>
	<div class="container-font">
	<div class="fontName" id="fontName">
		<label for="Arial" style="font-family: arial" onclick="textfield.document.execCommand('fontName', false, 'Arial')">Arial</label>
		<label for="Cursive" style="font-family: Cursive" onclick="textfield.document.execCommand('fontName', false, 'Cursive')">Cursive</label>
		<label for="Fantasy" style="font-family: Fantasy" onclick="textfield.document.execCommand('fontName', false, 'Fantasy')">Fantasy</label>
		<label for="Nunito" style="font-family: Nunito" onclick="textfield.document.execCommand('fontName', false, 'Nunito')">Nunito</label>
		<label for="Roboto" style="font-family: Roboto" onclick="textfield.document.execCommand('fontName', false, 'Roboto')">Roboto</label>
		<label for="Sans-serif" style="font-family: Sans-serif" onclick="textfield.document.execCommand('fontName', false, 'Sans-serif')">Sans-serif</label>
		<label for="Serif" style="font-family: Serif" onclick="textfield.document.execCommand('fontName', false, 'Serif')">Serif</label>
	</div>
	
	<div class="fontHeight" id="fontHeight">
		<label for="7" style="font-family: Nunito; font-size: 15px;" onclick="textfield.document.execCommand('fontSize', false, '7')">H1</label>
		<label for="6" style="font-family: Nunito; font-size: 15px;" onclick="textfield.document.execCommand('fontSize', false, '6')">H2</label>
		<label for="5" style="font-family: Nunito; font-size: 15px;" onclick="textfield.document.execCommand('fontSize', false, '5')">H3</label>
		<label for="4" style="font-family: Nunito; font-size: 15px;" onclick="textfield.document.execCommand('fontSize', false, '4')">Testo grande</label>
		<label for="3" style="font-family: Nunito; font-size: 15px;" onclick="textfield.document.execCommand('fontSize', false, '3')">Testo normale</label>
		<label for="2" style="font-family: Nunito; font-size: 15px;" onclick="textfield.document.execCommand('fontSize', false, '2')">Testo piccolo</label>
		<label for="1" style="font-family: Nunito; font-size: 15px;" onclick="textfield.document.execCommand('fontSize', false, '1')">Citazione</label>
	</div>
	
	<div class="fontColor" id="fontColor">
		<span id="#f54542" onclick="textfield.document.execCommand('foreColor', false, 'f54542')" style="width: 20px; height: 20px; border-radius: 20px; background-color: #f54542; cursor: pointer; display: inline-block;"></span>
		<span id="#f5d520" onclick="textfield.document.execCommand('foreColor', false, 'f5d520')" style="width: 20px; height: 20px; border-radius: 20px; background-color: #f5d520; cursor: pointer; display: inline-block;"></span>
		<span id="#42f56f" onclick="textfield.document.execCommand('foreColor', false, '42f56f')" style="width: 20px; height: 20px; border-radius: 20px; background-color: #42f56f; cursor: pointer; display: inline-block;"></span>
		<span id="#428af5" onclick="textfield.document.execCommand('foreColor', false, '428af5')" style="width: 20px; height: 20px; border-radius: 20px; background-color: #428af5; cursor: pointer; display: inline-block;"></span>
		<span id="#e942f5" onclick="textfield.document.execCommand('foreColor', false, 'e942f5')" style="width: 20px; height: 20px; border-radius: 20px; background-color: #e942f5; cursor: pointer; display: inline-block;"></span>
		<span id="#000000" onclick="textfield.document.execCommand('foreColor', false, '000000')" style="width: 20px; height: 20px; border-radius: 20px; background-color: #000000; cursor: pointer; display: inline-block;"></span>
	</div>
	</div>
	<div class="button_div">
  	<button type="button" data-cmd="fontName">
		<i class="fas fa-font" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="fontHeight">
		<i class="fas fa-text-height" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="fontColor">
		<i class="fas fa-paint-brush" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="bold">
		<i class="fas fa-bold" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="italic">
		<i class="fas fa-italic" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="underline">
		<i class="fas fa-underline" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="copy">
		<i class="far fa-copy" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="cut">
		<i class="fas fa-cut" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="justifyLeft">
		<i class="fas fa-align-left" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="justifyCenter">
		<i class="fas fa-align-center" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="justifyRight">
		<i class="fas fa-align-right" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="justifyFull">
		<i class="fas fa-align-justify" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="insertOrderedList">
		<i class="fas fa-list-ol" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="insertUnorderedList">
		<i class="fas fa-list" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="undo">
		<i class="fas fa-undo" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="redo">
		<i class="fas fa-redo" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="insertImage">
		<i class="far fa-image" aria-hidden="true"></i>
	</button>
	<button type="button" data-cmd="createLink">
		<i class="fas fa-link" aria-hidden="true"></i>
	</button>
	</div>
	 
	</div>
	
	<script src="http://cdn.jsdelivr.net/g/filesaver.js"></script>
	
	<script type="text/javascript">
	var titoloNota = document.cookie
	  .split('; ')
	  .find(row => row.startsWith('titolo'))
	  .split('=')[1];
	
	var contenuto = document.cookie
	  .split('; ')
	  .find(row => row.startsWith('contenuto'))
	  .split('=')[1];
	
	contenuto = contenuto.replaceAll(" ", "+");
	
	var contenutoHTML = atob(contenuto);
	
	var iframe = document.getElementById("output");
	var contentWindow = iframe.contentWindow,
	contentDocument = contentWindow.document,
	contentBody = contentDocument.body;
	contentBody.innerHTML = contenutoHTML
	
	document.getElementById('titolo_nota').value = titoloNota;
	
		window.onbeforeunload = function(){
			document.cookie = "titolo=; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
			document.cookie = "contenuto=; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
		};
	</script>
	
	<script type="text/javascript">
		var titoloNotaRapida = document.cookie
	  	.split('; ')
	  	.find(row => row.startsWith('titoloNotaRapida'))
	  	.split('=')[1];
	
		var contenutoNotaRapida = document.cookie
	  	.split('; ')
	  	.find(row => row.startsWith('contenutoNotaRapida'))
	  	.split('=')[1];
	
		var iframe = document.getElementById("output");
		var contentWindow = iframe.contentWindow,
		contentDocument = contentWindow.document,
		contentBody = contentDocument.body;
		contentBody.innerHTML = contenutoNotaRapida
	
		document.getElementById('titolo_nota').value = titoloNotaRapida;
		
		window.onbeforeunload = function(){
			document.cookie = "titoloNotaRapida=; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
			document.cookie = "contenutoNotaRapida=; expires=Thu, 01 Jan 1970 00:00:01 GMT;";
		};
	</script>
	<script>
	function showConferma(){
		document.getElementById("conferma").style.display = "flex";
	}
	
	function hideConferma(visibilità){
		var nameFile = document.getElementById('titolo_nota').value;
		var frameContent = document.getElementById('output').contentWindow.document.body.innerHTML;
		var content = "<style>@import url(https://fonts.googleapis.com/css2?family=Nunito&display=swap); @import url(https://fonts.googleapis.com/css2?family=Nunito&family=Roboto&display=swap);::-webkit-scrollbar {width: 10px;}::-webkit-scrollbar-track {background: #f1f1f1;}::-webkit-scrollbar-thumb {background: #888;border-radius: 10px;} </style>";
		console.log(content);
		frameContent = content + frameContent;
		getBase64(nameFile,visibilità,frameContent);
		document.getElementById("conferma").style.display = "none";	
	}
	
	function exitConferma(){
		document.getElementById("conferma").style.display = "none";
	}
	
	function fontPanel(id){
		switch(id){
		case "fontName":
			document.getElementById("fontColor").style.display = "none";
			document.getElementById("fontHeight").style.display = "none";
			if(document.getElementById(id).style.display == "block"){
				document.getElementById(id).style.display = "none";
			}else{
				document.getElementById(id).style.display = "block";
			}
			break;
		case "fontColor":
			document.getElementById("fontName").style.display = "none";
			document.getElementById("fontHeight").style.display = "none";
			if(document.getElementById(id).style.display == "block"){
				document.getElementById(id).style.display = "none";
			}else{
				document.getElementById(id).style.display = "block";
			}
			break;
		case "fontHeight":
			document.getElementById("fontName").style.display = "none";
			document.getElementById("fontColor").style.display = "none";
			if(document.getElementById(id).style.display == "block"){
				document.getElementById(id).style.display = "none";
			}else{
				document.getElementById(id).style.display = "block";
			}
			break;
		case "all":
			document.getElementById("fontName").style.display = "none";
			document.getElementById("fontColor").style.display = "none";
			document.getElementById("fontHeight").style.display = "none";
			break;
		}	
	}
	
	function getCookie(name) {
	    var dc = document.cookie;
	    var prefix = name + "=";
	    var begin = dc.indexOf("; " + prefix);
	    if (begin == -1) {
	        begin = dc.indexOf(prefix);
	        if (begin != 0) return null;
	    }
	    else
	    {
	        begin += 2;
	        var end = document.cookie.indexOf(";", begin);
	        if (end == -1) {
	        end = dc.length;
	        }
	    }
	    // because unescape has been deprecated, replaced with decodeURI
	    //return unescape(dc.substring(begin + prefix.length, end));
	    return decodeURI(dc.substring(begin + prefix.length, end));
	} 
	
	//Converte da file a stringa (Questa è da tenere in nota.html)
	function getBase64(nameFile,visibilità,frameContent) {
		var id;
		var myCookie = getCookie("id");
		if(myCookie==null){
			id=-1;
		}
		else{
			id=document.cookie.split('; ').find(row => row.startsWith('id')).split('=')[1];	
		}
		var data = btoa(frameContent);
		var xhttp = new XMLHttpRequest();
		xhttp.open("POST","/creaNota?id="+id+ "&titolo="+nameFile + "&contenuto=" + data + "&pubblico="+visibilità, true);
		xhttp.send();
	}

	function esportaPDF(doc){
		var dom = document.getElementById('output').contentWindow.document.documentElement;
	    html2canvas(dom, {
	        background: "#FFFFFF",//if specified If the background color of the div is not set, it will default to black, here is a pit 
//	        useCORS: true,
	        onrendered:function(canvas) {
	            //not generated pdf html page height 
	            var leftHeight = canvas.height;
	            var a4Width = 595.28-56.69
	            var a4Height = 841.89-56.69
	            //display a pdf generated html page canvas height; 
	            var a4HeightRef = Math.floor(canvas.width / a4Width * a4Height);
	            //pdf page offset 
	            var position = 0;
	            var pageData = canvas.toDataURL('image/jpeg', 1.0);
	            var pdf = new jsPDF('x', 'pt', 'a4');
	            var index = 1,
	                canvas1 = document.createElement('canvas'),
	                height;
	            pdf.setDisplayMode('fullwidth', 'continuous', 'FullScreen');
	            var pdfName= document.getElementById("titolo_nota");
	            var num = 0;
	            function createImpl(canvas) {
	                if (leftHeight > 0) {
	                    index++;
	                    var checkCount = 0;
	                    if (leftHeight > a4HeightRef) {
	                        var i = position + a4HeightRef;
	                        for (i = position + a4HeightRef; i >= position; i--) {
	                            var isWrite = true
	                            for (var j = 0; j < canvas.width; j++) {
	                                var c = canvas.getContext('2d').getImageData(j, i, 1, 1).data
	                                if (c[0] != 0xff || c[1] != 0xff || c[2] != 0xff) {
	                                    isWrite = false
	                                    break
	                                }
	                            }
	                            if (isWrite) {
	                                checkCount++
	                                if (checkCount >= 10) {
	                                    break
	                                }
	                            } else {
	                                checkCount = 0
	                            }
	                        }
	                        height = Math.round(i - position) || Math.min(leftHeight, a4HeightRef);
	                        if(height<=0){
	                            height = a4HeightRef;
	                        }
	                    } else {
	                        height = leftHeight;
	                    }
	                    canvas1.width = canvas.width;
	                    canvas1.height = height;
	                    //console.log(index, 'height:', height, 'pos', position);
	                    var ctx = canvas1.getContext('2d');
	                    ctx.drawImage(canvas, 0, position, canvas.width, height, 0, 0, canvas.width, height);
	                    var pageHeight = Math.round(a4Width / canvas.width * height);
	                   //pdf.setPageSize(null, pageHeight)
	                    if(position != 0){
	                        pdf.addPage();
	                    }
	                    pdf.addImage(canvas1.toDataURL('image/jpeg', 1.0), 'JPEG', 28.345, 28.345, a4Width, a4Width / canvas1.width * height);
	                    leftHeight -= height;
	                    position += height;
	                    if (leftHeight > 0) {
	                        setTimeout(createImpl, 500, canvas);
	                    } else {
	                        pdf.save(pdfName + '.pdf');
	                    }
	                }
	            }
	            //When the content does not exceed the display range of one page of pdf, there is no need to page 
	            if (leftHeight < a4HeightRef) {
	                pdf.addImage(pageData, 'JPEG', 28.345, 28.345, a4Width, a4Width / canvas.width * leftHeight);
	                pdf.save(pdfName + '.pdf');
	            } else {
	                try {
	                    pdf.deletePage(0);
	                    setTimeout(createImpl, 500, canvas);
	                } catch (err) {
	                    console.log(err);
	                }
	            }
	        }
	    })
	}
	function font(){
		var iframe = document.getElementById("output");
		var contentWindow = iframe.contentWindow,
    	contentDocument = contentWindow.document,
    	contentBody = contentDocument.head;
		contentBody.innerHTML = '<style>@import url(https://fonts.googleapis.com/css2?family=Nunito&display=swap); @import url(https://fonts.googleapis.com/css2?family=Nunito&family=Roboto&display=swap);::-webkit-scrollbar {width: 10px;}::-webkit-scrollbar-track {background: #f1f1f1;}::-webkit-scrollbar-thumb {background: #888;border-radius: 10px;} @charset "UTF-8"; </style> ';};
	
	const buttons = document.querySelectorAll('button');
	textfield.document.designMode = "On";
	textfield.document.body.style.overflowWrap = "break-word";
	for(let i = 0; i < buttons.length; i++){
		buttons[i].addEventListener('click', ()=>{
			let cmd = buttons[i].getAttribute('data-cmd');
			if(buttons[i].name === "active"){
				buttons[i].classList.toggle('active');
			}
			
			if(cmd == 'fontName' || cmd == 'fontColor' || cmd == 'fontHeight'){
				if(cmd == 'fontName'){
					fontPanel("fontName");
				}
				if(cmd == 'fontColor'){
					fontPanel("fontColor");
				}
				if(cmd == 'fontHeight'){
					fontPanel("fontHeight");
				}
			}else{
				fontPanel("all");
				
				if(cmd == 'insertImage' || cmd == 'createLink'){
					let url = prompt('Inserisci il link che vuoi inserire', '');
					if(url != null){
						textfield.document.execCommand(cmd, false, url);
					}
				}else{
					textfield.document.execCommand(cmd, false, null);
				}
			}
		})
	}
	</script>
</body>
</html>